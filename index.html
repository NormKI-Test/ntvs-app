import React, { useState, useRef } from "react";

export default function CameraPatternAuth() {
  const videoRef = useRef();
  const [status, setStatus] = useState("Bereit");
  const [error, setError] = useState("");
  const [stream, setStream] = useState(null);
  const [photo, setPhoto] = useState(null);
  const [gps, setGps] = useState(null);
  const [patternBands, setPatternBands] = useState([]);

  // Get GPS coordinate
  const fetchGPS = () => {
    if (!navigator.geolocation) {
      setError(
        "GPS nicht verfügbar. Bitte Position aktivieren & Browser erlauben."
      );
      return;
    }
    navigator.geolocation.getCurrentPosition(
      position => {
        setGps({
          lat: position.coords.latitude,
          lng: position.coords.longitude
        });
      },
      err => {
        setError(
          "GPS konnte nicht abgerufen werden. Bitte Standort teilen & Try Again."
        );
      }
    );
  };

  // Start Camera with permissions
  const startCamera = async () => {
    setStatus("Fordere Kamera-Erlaubnis an...");
    setError("");
    fetchGPS();
    try {
      const localStream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: "environment",
          width: { ideal: 1920 },
          height: { ideal: 1080 }
        }
      });
      setStatus("Kamera aktiv");
      videoRef.current.srcObject = localStream;
      setStream(localStream);
    } catch (err) {
      setStatus("Fehler beim Starten der Kamera");
      setError("Kamerazugriff verweigert oder nicht verfügbar. Berechtigungen prüfen.");
    }
  };

  // Main: capture photo with simulated pattern, draw bands, download
  const capturePhoto = async () => {
    setStatus("Foto wird aufgenommen & Pattern eingebettet...");
    const canvas = document.createElement("canvas");
    const video = videoRef.current;
    const width = video.videoWidth;
    const height = video.videoHeight;
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, width, height);
    // Pattern: demo 15 bands at intervals
    const bands = Array.from({ length: 15 }, (_, i) => Math.floor((height / 16) * (i + 1)));
    setPatternBands(bands);
    // Draw yellow bands as overlay
    ctx.save();
    ctx.strokeStyle = "rgba(255,255,0,0.7)";
    ctx.lineWidth = 5;
    bands.forEach(y => {
      ctx.beginPath();
      ctx.moveTo(0, y);
      ctx.lineTo(width, y);
      ctx.stroke();
    });
    ctx.restore();
    setPhoto(canvas.toDataURL("image/png"));
    setStatus("Foto aufgenommen und Pattern sichtbar");
  };

  // Download current photo
  const downloadPhoto = () => {
    if (!photo) return;
    const link = document.createElement("a");
    link.href = photo;
    link.download = "normki-photo-pattern.png";
    link.click();
  };

  // Download JSON
  const downloadLog = () => {
    if (!gps) return;
    const log = {
      device_id: "NORMKI_CAM_001",
      timestamp: new Date().toISOString(),
      gps: gps.lat + "," + gps.lng,
      pattern_bands: patternBands
    };
    const blob = new Blob([JSON.stringify(log, null, 2)], {
      type: "application/json"
    });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "normki-photo-pattern-log.json";
    link.click();
  };

  return (
    <div style={{ background: "#101932", minHeight: "100vh", color: "white", padding: 16 }}>
      <h2>NormKI Flash-Pattern Auth (Demo)</h2>
      <p>
        Nur Rear-Kamera, nur Fotoaufnahme, GPS PFLICHT. Beim Download siehst du die
        markierten Pattern-Bands im Bild und bekommst den JSON-Log mit.
      </p>
      <video
        ref={videoRef}
        autoPlay
        playsInline
        style={{ width: 350, borderRadius: 18, boxShadow: "0 0 30px #333" }}
      ></video>
      <div style={{ margin: "18px 0" }}>
        <button style={{ fontSize: 18, padding: 14 }} onClick={startCamera}>
          Kamera starten & GPS holen
        </button>
        <button style={{ fontSize: 18, padding: 14, marginLeft: 14 }} onClick={capturePhoto}>
          Foto aufnehmen
        </button>
        <button style={{ padding: 14, marginLeft: 14 }} onClick={downloadPhoto}>
          Bild herunterladen
        </button>
        <button style={{ padding: 14, marginLeft: 14 }} onClick={downloadLog}>
          JSON Log herunterladen
        </button>
      </div>
      {status && <div style={{ background: "#223" }}>{status}</div>}
      {error && <div style={{ color: "#f33" }}>{error}</div>}
      {photo && (
        <div>
          <h4>Preview mit Pattern-Overlay:</h4>
          <img
            src={photo}
            alt="photo-preview"
            style={{ width: 350, borderRadius: 18, border: "3px solid #ffd600" }}
          />
        </div>
      )}
    </div>
  );
}
