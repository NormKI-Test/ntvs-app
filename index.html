<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NORMKI ‚Äì Tekton Photo Verification</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-main: #020617;
      --bg-elevated: #020617;
      --border-soft: rgba(51, 65, 85, 0.9);
      --accent: #2563eb;
      --accent-soft: #60a5fa;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI",
        Roboto, sans-serif;
      background: radial-gradient(circle at top, #020617 0%, #020617 55%, #02010a 100%);
      color: var(--text-main);
      min-height: 100vh;
      overflow: hidden;
    }

    /* HEADER */

    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      padding: 14px 22px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
      background: linear-gradient(
        to bottom,
        rgba(15, 23, 42, 0.98),
        rgba(15, 23, 42, 0.7),
        transparent
      );
      backdrop-filter: blur(16px);
      border-bottom: 1px solid rgba(30, 64, 175, 0.45);
    }

    .logo-wrap {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-mark {
      width: 32px;
      height: 32px;
      border-radius: 10px;
      border: 1px solid rgba(37, 99, 235, 0.9);
      background: radial-gradient(circle at top, #020617, #020617);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.12em;
      color: var(--text-main);
      box-shadow: 0 0 18px rgba(37, 99, 235, 0.6);
    }

    .logo-text {
      display: flex;
      flex-direction: column;
    }

    .logo-main {
      font-size: 17px;
      font-weight: 700;
      letter-spacing: 0.2em;
    }

    .logo-sub {
      font-size: 11px;
      opacity: 0.7;
    }

    .icon-button {
      width: 38px;
      height: 38px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: #020617;
      color: var(--text-main);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .icon-button:hover {
      background: #0b1120;
      transform: translateY(-1px);
    }

    /* MAIN / HERO */

    .main-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 92px 18px 24px;
      position: relative;
      z-index: 2;
    }

    .hero-card {
      width: 100%;
      max-width: 520px;
      border-radius: 22px;
      padding: 22px 22px 20px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-soft);
      box-shadow:
        0 24px 60px rgba(15, 23, 42, 0.95),
        0 0 0 1px rgba(15, 23, 42, 1);
      position: relative;
      transition: opacity 0.35s ease, transform 0.35s ease;
      animation: heroFloat 4s ease-in-out infinite;
    }

    .hero-card.off {
      opacity: 0;
      transform: translateY(16px) scale(0.98);
      pointer-events: none;
    }

    @keyframes heroFloat {
      0% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-4px) scale(1.005); }
      100% { transform: translateY(0) scale(1); }
    }

    .hero-content {
      position: relative;
      z-index: 1;
    }

    .hero-eyebrow {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-muted);
      margin-bottom: 8px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .hero-eyebrow-pill {
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: #020617;
      color: var(--text-main);
    }

    .hero-title {
      font-size: 24px;
      line-height: 1.3;
      font-weight: 700;
      margin-bottom: 8px;
      color: #f9fafb;
    }

    .hero-title span {
      color: var(--accent-soft);
    }

    .hero-sub {
      font-size: 13px;
      color: #d1d5db;
      line-height: 1.6;
      margin-bottom: 16px;
    }

    .hero-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 18px;
    }

    .badge {
      font-size: 11px;
      padding: 6px 9px;
      border-radius: 999px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      background: #020617;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      color: var(--text-main);
    }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    .hero-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .start-button {
      flex: 1;
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      border-radius: 999px;
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: #f9fafb;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow:
        0 14px 34px rgba(15, 23, 42, 0.95),
        0 0 0 1px rgba(15, 23, 42, 1);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      position: relative;
      overflow: hidden;
    }

    .start-button::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(
        120deg,
        transparent,
        rgba(255, 255, 255, 0.2),
        transparent
      );
      transform: translateX(-120%);
      opacity: 0;
    }

    .start-button:hover::after {
      opacity: 1;
      animation: btnShine 0.9s ease-out;
    }

    @keyframes btnShine {
      0% { transform: translateX(-120%); }
      100% { transform: translateX(120%); }
    }

    .start-button:hover {
      transform: translateY(-1px);
    }

    .start-button:disabled {
      opacity: 0.65;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .start-button span.icon {
      font-size: 16px;
    }

    .loader-wrap {
      display: none;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .loader-wrap.active {
      display: inline-flex;
    }

    .loader-spinner {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 2px solid rgba(75, 85, 99, 0.9);
      border-top-color: var(--accent);
      animation: spin 0.9s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .helper-text {
      font-size: 11px;
      opacity: 0.75;
      line-height: 1.5;
      color: var(--text-muted);
    }

    .helper-text b {
      opacity: 1;
      color: var(--text-main);
    }

    /* VIDEO & CAPTURE */

    .video-container {
      position: fixed;
      inset: 0;
      z-index: 1;
      display: none;
    }

    .video-container.active {
      display: block;
    }

    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      background: #020617;
    }

    .capture-button {
      position: fixed;
      bottom: 34px;
      left: 50%;
      transform: translateX(-50%);
      width: 78px;
      height: 78px;
      border-radius: 999px;
      border: 3px solid rgba(148, 163, 184, 0.95);
      background: #f9fafb;
      cursor: pointer;
      z-index: 120;
      display: none;
      transition: all 0.15s ease;
      box-shadow:
        0 12px 32px rgba(0, 0, 0, 0.85),
        0 0 0 1px rgba(15, 23, 42, 1);
      animation: pulseCapture 1.8s ease-in-out infinite;
    }

    .capture-button::before {
      content: "";
      position: absolute;
      inset: 7px;
      border-radius: 999px;
      background: #e5e7eb;
    }

    .capture-button:active:not(:disabled) {
      transform: translateX(-50%) scale(0.96);
    }

    .capture-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
      animation: none;
    }

    @keyframes pulseCapture {
      0% { box-shadow: 0 12px 32px rgba(0, 0, 0, 0.9); }
      50% { box-shadow: 0 12px 42px rgba(37, 99, 235, 0.35); }
      100% { box-shadow: 0 12px 32px rgba(0, 0, 0, 0.9); }
    }

    .status-text {
      position: fixed;
      bottom: 126px;
      left: 50%;
      transform: translateX(-50%);
      padding: 9px 16px;
      background: rgba(15, 23, 42, 0.96);
      border-radius: 999px;
      font-size: 13px;
      z-index: 120;
      display: none;
      border: 1px solid rgba(75, 85, 99, 0.9);
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.95);
      color: var(--text-main);
    }

    .status-text.pulse {
      animation: statusPulse 0.18s ease-out;
    }

    @keyframes statusPulse {
      0% { transform: translateX(-50%) scale(1); }
      50% { transform: translateX(-50%) scale(1.03); }
      100% { transform: translateX(-50%) scale(1); }
    }

    /* BACK BUTTON IN CAMERA */

    .overlay-back-btn {
      position: fixed;
      top: 14px;
      left: 14px;
      z-index: 130;
      display: none;
      width: 38px;
      height: 38px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.96);
      color: var(--text-main);
      font-size: 18px;
      cursor: pointer;
      align-items: center;
      justify-content: center;
    }

    .overlay-back-btn.visible {
      display: flex;
    }

    /* FLASH OVERLAY */

    .flash-overlay {
      position: fixed;
      inset: 0;
      background: #ffffff;
      opacity: 0;
      pointer-events: none;
      z-index: 200;
    }

    .flash-overlay.active {
      animation: flashBlink 0.16s ease-out;
    }

    @keyframes flashBlink {
      0% { opacity: 0; }
      30% { opacity: 0.3; }
      100% { opacity: 0; }
    }

    /* PREVIEW */

    .preview-container {
      position: fixed;
      inset: 0;
      background: #020617;
      z-index: 500;
      display: none;
      flex-direction: column;
      align-items: center;
      padding: 90px 18px 20px;
      overflow-y: auto;
    }

    .preview-container.active {
      display: flex;
    }

    .preview-inner {
      width: 100%;
      max-width: 520px;
      animation: previewFade 0.22s ease-out;
    }

    @keyframes previewFade {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .preview-header {
      width: 100%;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 10px;
    }

    .preview-title {
      font-size: 18px;
      font-weight: 600;
      color: #f9fafb;
    }

    .preview-sub {
      font-size: 11px;
      opacity: 0.72;
      margin-top: 4px;
      color: var(--text-muted);
    }

    .preview-grid {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin-bottom: 10px;
    }

    .preview-block {
      background: #020617;
      border-radius: 16px;
      padding: 10px 10px 12px;
      border: 1px solid rgba(51, 65, 85, 0.95);
      box-shadow: 0 16px 32px rgba(15, 23, 42, 0.98);
    }

    .preview-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 6px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
    }

    .preview-image {
      width: 100%;
      max-height: 52vh;
      object-fit: contain;
      border-radius: 10px;
      background: #000;
    }

    .preview-actions {
      width: 100%;
      display: flex;
      gap: 10px;
      margin-top: 6px;
    }

    .btn-pill {
      flex: 1;
      padding: 10px 12px;
      font-size: 13px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.15s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: #f9fafb;
      font-weight: 600;
      box-shadow:
        0 12px 30px rgba(15, 23, 42, 1),
        0 0 0 1px rgba(15, 23, 42, 1);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: #020617;
      color: var(--text-main);
      border: 1px solid rgba(75, 85, 99, 0.95);
    }

    .btn-secondary:hover {
      transform: translateY(-1px);
    }

    canvas {
      display: none;
    }

    @media (min-width: 700px) {
      .main-container {
        padding-top: 110px;
      }
      .hero-card {
        padding: 24px 24px 22px;
      }
      .hero-title {
        font-size: 26px;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo-wrap">
      <div class="logo-mark">NK</div>
      <div class="logo-text">
        <div class="logo-main">NORMKI</div>
        <div class="logo-sub">Tekton Photo Verification</div>
      </div>
    </div>
    <button class="icon-button" id="infoBtn">?</button>
  </header>

  <main class="main-container">
    <div class="hero-card" id="heroCard">
      <div class="hero-content">
        <div class="hero-eyebrow">
          NTVS
          <span class="hero-eyebrow-pill">Rolling-Shutter Pattern</span>
        </div>
        <div class="hero-title">
          <span>Verifizierte</span> Beweisfotos f√ºr Baustellen & Geb√§ude.
        </div>
        <div class="hero-sub">
          NORMKI erstellt ein Beweisfoto mit Zeitstempel, optionalen GPS-Daten
          und einem eindeutigen Hash-Siegel direkt im Bild. Zus√§tzlich wird
          immer das Original ohne Overlay gesichert ‚Äì f√ºr Analyse & Dokumentation.
        </div>

        <div class="hero-badges">
          <div class="badge">
            <span class="badge-dot"></span> GPS-Tag (optional)
          </div>
          <div class="badge">
            üîí SHA-256 Hash
          </div>
          <div class="badge">
            üìÅ Original + Verified
          </div>
        </div>

        <div class="hero-footer">
          <button id="startBtn" class="start-button">
            <span class="icon">‚óé</span>
            Scan starten
          </button>
          <div id="loaderWrap" class="loader-wrap">
            <div class="loader-spinner"></div>
            <span>Initialisierung‚Ä¶</span>
          </div>
        </div>

        <div class="helper-text">
          Nutzt <b>Kamera</b> und ‚Äì wenn freigegeben ‚Äì <b>Standort</b>.
          Blockiertes GPS wird durch einen Demo-Standort ersetzt, damit der
          Ablauf nicht h√§ngen bleibt.
        </div>
      </div>
    </div>
  </main>

  <div id="videoContainer" class="video-container">
    <video id="video" autoplay playsinline></video>
  </div>

  <button id="backCameraBtn" class="overlay-back-btn">‚Üê</button>

  <button id="captureBtn" class="capture-button"></button>

  <div id="statusText" class="status-text"></div>

  <div id="flashOverlay" class="flash-overlay"></div>

  <div id="previewContainer" class="preview-container">
    <div class="preview-inner">
      <div class="preview-header">
        <div>
          <div class="preview-title">Verifizierte Aufnahme</div>
          <div class="preview-sub">
            Beide Bilder werden lokal auf deinem Ger√§t gespeichert.
          </div>
        </div>
        <span style="font-size:11px; color:#6b7280;">NORMKI ‚Ä¢ Tekton</span>
      </div>

      <div class="preview-grid">
        <div class="preview-block">
          <div class="preview-label">Mit Hash & Linien-Code</div>
          <img id="previewWithPattern" class="preview-image" alt="NORMKI Verified" />
        </div>
        <div class="preview-block">
          <div class="preview-label">Original</div>
          <img id="previewWithoutPattern" class="preview-image" alt="Original" />
        </div>
      </div>

      <div id="previewMeta" style="font-size:11px;color:#9ca3af;margin:4px 2px 4px;"></div>

      <div class="preview-actions">
        <button id="previewBackBtn" class="btn-pill btn-secondary">Neues Foto</button>
        <button id="downloadBtn" class="btn-pill btn-primary">
          ‚¨áÔ∏è Lokal speichern
        </button>
      </div>
    </div>
  </div>

  <canvas id="canvas"></canvas>

  <script>
    const NORMKI_PATTERN = [1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0];

    let stream = null;
    let gps = null;
    let photoWithPattern = null;
    let photoWithoutPattern = null;
    let captureTimestampIso = null;
    let captureHashHex = null;
    let captureCaseId = null;

    const startBtn = document.getElementById("startBtn");
    const captureBtn = document.getElementById("captureBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const previewBackBtn = document.getElementById("previewBackBtn");
    const backCameraBtn = document.getElementById("backCameraBtn");
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const videoContainer = document.getElementById("videoContainer");
    const statusText = document.getElementById("statusText");
    const loaderWrap = document.getElementById("loaderWrap");
    const previewContainer = document.getElementById("previewContainer");
    const previewWithPattern = document.getElementById("previewWithPattern");
    const previewWithoutPattern = document.getElementById("previewWithoutPattern");
    const previewMeta = document.getElementById("previewMeta");
    const infoBtn = document.getElementById("infoBtn");
    const heroCard = document.getElementById("heroCard");
    const flashOverlay = document.getElementById("flashOverlay");

    const isIOS = /iP(ad|hone|od)/.test(navigator.userAgent);
    const supportsSubtle = !!(window.crypto && window.crypto.subtle);

    function vibrate(pattern = [80, 30, 80]) {
      if (!navigator.vibrate || isIOS) {
        statusText.classList.remove("pulse");
        void statusText.offsetWidth;
        statusText.classList.add("pulse");
        return;
      }
      navigator.vibrate(pattern);
    }

    function showStatus(text) {
      statusText.textContent = text;
      statusText.style.display = "block";
    }

    function hideStatus() {
      statusText.style.display = "none";
      statusText.classList.remove("pulse");
    }

    function showLoader() {
      loaderWrap.classList.add("active");
    }

    function hideLoader() {
      loaderWrap.classList.remove("active");
    }

    function triggerFlash() {
      flashOverlay.classList.remove("active");
      void flashOverlay.offsetWidth;
      flashOverlay.classList.add("active");
    }

    async function getGPS() {
      return new Promise((resolve) => {
        if (!navigator.geolocation) {
          resolve({ lat: 48.210033, lng: 16.363449, demo: true });
          return;
        }

        const timeout = setTimeout(() => {
          resolve({ lat: 48.210033, lng: 16.363449, demo: true });
        }, 3000);

        navigator.geolocation.getCurrentPosition(
          (position) => {
            clearTimeout(timeout);
            resolve({
              lat: position.coords.latitude,
              lng: position.coords.longitude,
              demo: false,
            });
          },
          () => {
            clearTimeout(timeout);
            resolve({ lat: 48.210033, lng: 16.363449, demo: true });
          },
          {
            enableHighAccuracy: true,
            timeout: 2500,
            maximumAge: 0,
          }
        );
      });
    }

    async function startCamera() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showStatus("Kamera wird vom Browser nicht unterst√ºtzt.");
        return false;
      }

      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: { ideal: "environment" },
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          },
          audio: false,
        });

        video.srcObject = stream;

        await new Promise((resolve) => {
          if (video.readyState >= 2) return resolve();
          video.onloadedmetadata = () => resolve();
        });

        videoContainer.classList.add("active");
        captureBtn.style.display = "block";
        backCameraBtn.classList.add("visible");
        showStatus("Bereit ‚Äì Bild ausrichten und ausl√∂sen.");
        vibrate([100, 30, 100]);

        heroCard.classList.add("off");
        return true;
      } catch (err) {
        console.error(err);
        showStatus("Kamera-Zugriff verweigert oder nicht verf√ºgbar.");
        return false;
      }
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach((t) => t.stop());
        stream = null;
      }
      video.srcObject = null;
      videoContainer.classList.remove("active");
      captureBtn.style.display = "none";
      backCameraBtn.classList.remove("visible");
    }

    async function executeFlashPattern() {
      if (!stream) return;
      const track = stream.getVideoTracks()[0];
      if (!track) return;

      const capabilities = track.getCapabilities ? track.getCapabilities() : {};
      if (!capabilities.torch) {
        return;
      }

      for (let i = 0; i < NORMKI_PATTERN.length; i++) {
        const bit = NORMKI_PATTERN[i];
        try {
          await track.applyConstraints({
            advanced: [{ torch: bit === 1 }],
          });
        } catch (e) {
          console.log("Torch-Fehler:", e);
          break;
        }

        if (i % 5 === 0) vibrate([40]);
        await new Promise((resolve) => setTimeout(resolve, 50));
      }

      try {
        await track.applyConstraints({ advanced: [{ torch: false }] });
      } catch (_) {}
    }

    async function computeCaptureHash(imageDataUrl, timestampIso, gpsObj, pattern) {
      const base64 = imageDataUrl.split(",")[1] || "";
      const binary = atob(base64);
      const len = binary.length;
      const imageBytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) {
        imageBytes[i] = binary.charCodeAt(i);
      }

      const metaString = JSON.stringify({
        timestampIso,
        gps: gpsObj,
        pattern
      });
      const metaBytes = new TextEncoder().encode(metaString);

      const combined = new Uint8Array(imageBytes.length + metaBytes.length);
      combined.set(imageBytes, 0);
      combined.set(metaBytes, imageBytes.length);

      const digest = await crypto.subtle.digest("SHA-256", combined);
      const hashArray = Array.from(new Uint8Array(digest));
      return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
    }

    function buildLineCodeBytes(timestampIso, gpsObj, hashHex) {
      const tsSec = Math.floor(new Date(timestampIso).getTime() / 1000);

      const lat = gpsObj && typeof gpsObj.lat === "number" ? gpsObj.lat : 0;
      const lng = gpsObj && typeof gpsObj.lng === "number" ? gpsObj.lng : 0;

      const latScaled = Math.max(
        0,
        Math.min(
          65535,
          Math.round(((lat + 90) / 180) * 65535)
        )
      );

      const lngScaled = Math.max(
        0,
        Math.min(
          65535,
          Math.round(((lng + 180) / 360) * 65535)
        )
      );

      const safeHash = (hashHex || "").padEnd(8, "0");
      const hashBytes = [];
      for (let i = 0; i < 8; i += 2) {
        hashBytes.push(parseInt(safeHash.slice(i, i + 2), 16));
      }

      const bytes = [];
      bytes.push((tsSec >>> 24) & 0xff);
      bytes.push((tsSec >>> 16) & 0xff);
      bytes.push((tsSec >>> 8) & 0xff);
      bytes.push(tsSec & 0xff);

      bytes.push((latScaled >>> 8) & 0xff);
      bytes.push(latScaled & 0xff);

      bytes.push((lngScaled >>> 8) & 0xff);
      bytes.push(lngScaled & 0xff);

      bytes.push(...hashBytes);

      return bytes;
    }

    function drawLineCode(ctx, canvasWidth, baseY, bytes) {
      const rows = bytes.length;
      const cols = 8;

      const cellHeight = 6;
      const gapY = 2;
      const cellWidth = 10;
      const gapX = 3;

      const xStart = 24;

      for (let row = 0; row < rows; row++) {
        const b = bytes[row];
        const yTop = baseY + row * (cellHeight + gapY);

        for (let col = 0; col < cols; col++) {
          const bit = (b >> (7 - col)) & 1;
          const xLeft = xStart + col * (cellWidth + gapX);

          if (bit === 1) {
            ctx.fillStyle = "rgba(96, 165, 250, 0.9)";
            ctx.fillRect(xLeft, yTop, cellWidth, cellHeight);
          } else {
            ctx.fillStyle = "rgba(30, 64, 175, 0.25)";
            ctx.fillRect(
              xLeft,
              yTop + cellHeight * 0.3,
              cellWidth,
              cellHeight * 0.4
            );
          }
        }
      }

      const totalHeight = rows * (cellHeight + gapY);
      ctx.strokeStyle = "rgba(51, 65, 85, 0.9)";
      ctx.lineWidth = 1;
      ctx.strokeRect(
        xStart - 6,
        baseY - 4,
        cols * (cellWidth + gapX) - gapX + 12,
        totalHeight + 8
      );
    }

    async function capturePhoto() {
      if (!stream) {
        showStatus("Keine aktive Kamera.");
        return;
      }

      captureBtn.disabled = true;
      showStatus("Pattern wird angewendet‚Ä¶");
      vibrate([70]);

      await executeFlashPattern();
      triggerFlash();

      canvas.width = video.videoWidth || 1920;
      canvas.height = video.videoHeight || 1080;
      const ctx = canvas.getContext("2d");

      captureTimestampIso = new Date().toISOString();
      const timestampLocal = new Date(captureTimestampIso).toLocaleString("de-DE");

      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      photoWithoutPattern = canvas.toDataURL("image/png");

      if (!supportsSubtle) {
        showStatus("Hash-Berechnung im Browser nicht m√∂glich. Bitte modernen Browser / HTTPS verwenden.");
        captureHashHex = null;
      } else {
        try {
          captureHashHex = await computeCaptureHash(
            photoWithoutPattern,
            captureTimestampIso,
            gps,
            NORMKI_PATTERN
          );
        } catch (e) {
          console.error("Hash-Berechnung fehlgeschlagen:", e);
          captureHashHex = null;
        }
      }

      captureCaseId =
        "NTVS-" +
        (captureHashHex
          ? captureHashHex.slice(0, 10).toUpperCase()
          : Date.now().toString(36).toUpperCase());

      const hashShort = captureHashHex
        ? captureHashHex.slice(0, 12).toUpperCase()
        : NORMKI_PATTERN.join("");

      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const overlayHeight = 220;
      ctx.fillStyle = "rgba(15, 23, 42, 0.96)";
      ctx.fillRect(0, 0, canvas.width, overlayHeight);

      ctx.fillStyle = "#f9fafb";
      ctx.font = "bold 30px -apple-system, BlinkMacSystemFont, sans-serif";
      ctx.fillText("NORMKI VERIFIED", 24, 46);

      ctx.font = "11px -apple-system, BlinkMacSystemFont, sans-serif";
      ctx.fillStyle = "#9ca3af";
      ctx.textAlign = "right";
      ctx.fillText("NTVS v1.0", canvas.width - 24, 30);
      ctx.textAlign = "start";

      const isDemo = !gps || gps.demo;

      ctx.font = "16px -apple-system, BlinkMacSystemFont, sans-serif";
      ctx.fillStyle = "#d1d5db";

      const gpsText = isDemo
        ? `GPS: DEMO (${(gps?.lat ?? 48.21).toFixed(4)}, ${(gps?.lng ?? 16.36).toFixed(4)})`
        : `GPS: ${gps.lat.toFixed(6)}, ${gps.lng.toFixed(6)}`;
      ctx.fillText(gpsText, 24, 80);

      if (isDemo) {
        ctx.font = "11px -apple-system, BlinkMacSystemFont, sans-serif";
        ctx.fillStyle = "#f97316";
        ctx.fillText("Warnung: Standort nur Demo ‚Äì nicht gerichtsfest", 24, 102);

        ctx.font = "16px -apple-system, BlinkMacSystemFont, sans-serif";
        ctx.fillStyle = "#d1d5db";
        ctx.fillText(`Zeit: ${timestampLocal}`, 24, 124);
        ctx.font = "13px -apple-system, BlinkMacSystemFont, sans-serif";
        ctx.fillStyle = "#e5e7eb";
        ctx.fillText(`Case: ${captureCaseId}`, 24, 146);
        ctx.font = "bold 12px monospace";
        ctx.fillStyle = "#60a5fa";
        ctx.fillText(`Hash: ${hashShort}`, 24, 168);
        ctx.font = "12px -apple-system, BlinkMacSystemFont, sans-serif";
        ctx.fillStyle = "#e5e7eb";
        ctx.fillText("Pattern Verification Active", 24, 190);
        ctx.fillText("Rolling-Shutter Authentication", 24, 210);
      } else {
        ctx.font = "16px -apple-system, BlinkMacSystemFont, sans-serif";
        ctx.fillStyle = "#d1d5db";
        ctx.fillText(`Zeit: ${timestampLocal}`, 24, 102);
        ctx.font = "13px -apple-system, BlinkMacSystemFont, sans-serif";
        ctx.fillStyle = "#e5e7eb";
        ctx.fillText(`Case: ${captureCaseId}`, 24, 124);
        ctx.font = "bold 12px monospace";
        ctx.fillStyle = "#60a5fa";
        ctx.fillText(`Hash: ${hashShort}`, 24, 146);
        ctx.font = "12px -apple-system, BlinkMacSystemFont, sans-serif";
        ctx.fillStyle = "#e5e7eb";
        ctx.fillText("Pattern Verification Active", 24, 168);
        ctx.fillText("Rolling-Shutter Authentication", 24, 188);
      }

      const lineCodeBytes = buildLineCodeBytes(
        captureTimestampIso,
        gps || { lat: 0, lng: 0, demo: true },
        captureHashHex
      );

      const codeBaseY = overlayHeight + 10;
      drawLineCode(ctx, canvas.width, codeBaseY, lineCodeBytes);

      const patternTopMargin = 16;
      const rows = lineCodeBytes.length;
      const cellHeight = 6;
      const gapY = 2;
      const codeHeight = rows * (cellHeight + gapY) + 8;

      const startY = codeBaseY + codeHeight + patternTopMargin;
      const patternHeight = canvas.height - startY - 24;
      const lineHeight = patternHeight / NORMKI_PATTERN.length;

      ctx.shadowBlur = 8;
      ctx.shadowColor = "rgba(96, 165, 250, 0.85)";

      for (let i = 0; i < NORMKI_PATTERN.length; i++) {
        const y = startY + i * lineHeight;
        const active = NORMKI_PATTERN[i] === 1;
        const opacity = active ? 0.6 : 0.18;

        ctx.strokeStyle = `rgba(96, 165, 250, ${opacity})`;
        ctx.lineWidth = active ? 4 : 2;
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
      }

      ctx.shadowBlur = 0;

      const sealRadius = 60;
      const sealX = canvas.width - sealRadius - 24;
      const sealY = canvas.height - sealRadius - 24;

      ctx.save();
      ctx.beginPath();
      ctx.arc(sealX, sealY, sealRadius, 0, Math.PI * 2);
      ctx.fillStyle = "rgba(15, 23, 42, 0.98)";
      ctx.fill();
      ctx.strokeStyle = "rgba(75, 85, 99, 0.95)";
      ctx.lineWidth = 3;
      ctx.stroke();

      ctx.textAlign = "center";
      ctx.textBaseline = "middle";

      ctx.fillStyle = "#e5e7eb";
      ctx.font = "bold 18px -apple-system, BlinkMacSystemFont, sans-serif";
      ctx.fillText("NORMKI", sealX, sealY - 10);

      ctx.font = "10px monospace";
      ctx.fillStyle = "#9ca3af";
      ctx.fillText(hashShort, sealX, sealY + 10);

      ctx.restore();
      ctx.textAlign = "start";
      ctx.textBaseline = "alphabetic";

      photoWithPattern = canvas.toDataURL("image/png");

      previewWithPattern.src = photoWithPattern;
      previewWithoutPattern.src = photoWithoutPattern;
      if (previewMeta) {
        previewMeta.textContent = `Case: ${captureCaseId} ¬∑ Hash: ${hashShort}`;
      }
      previewContainer.classList.add("active");

      hideStatus();
      vibrate([100, 40, 100]);
    }

    function downloadPhotos() {
      if (!photoWithPattern || !photoWithoutPattern) return;

      vibrate([100, 30, 100]);
      const ts = Date.now();

      const link1 = document.createElement("a");
      link1.href = photoWithPattern;
      link1.download = `normki-verified-${ts}.png`;
      document.body.appendChild(link1);
      link1.click();
      document.body.removeChild(link1);

      setTimeout(() => {
        const link2 = document.createElement("a");
        link2.href = photoWithoutPattern;
        link2.download = `normki-original-${ts}.png`;
        document.body.appendChild(link2);
        link2.click();
        document.body.removeChild(link2);
      }, 400);
    }

    function backToCamera() {
      vibrate([40]);
      previewContainer.classList.remove("active");
      captureBtn.disabled = false;
      showStatus("Bereit ‚Äì neues Foto aufnehmen.");
    }

    function backToHero() {
      vibrate([40]);
      stopCamera();
      hideStatus();
      heroCard.classList.remove("off");
      startBtn.disabled = false;
    }

    startBtn.addEventListener("click", async () => {
      startBtn.disabled = true;
      showLoader();
      showStatus("GPS wird gepr√ºft‚Ä¶");
      gps = await getGPS();
      showStatus("Kamera wird gestartet‚Ä¶");

      const camOk = await startCamera();
      hideLoader();

      if (!camOk) {
        startBtn.disabled = false;
        heroCard.classList.remove("off");
      }
    });

    captureBtn.addEventListener("click", capturePhoto);
    downloadBtn.addEventListener("click", downloadPhotos);
    previewBackBtn.addEventListener("click", backToCamera);
    backCameraBtn.addEventListener("click", backToHero);

    infoBtn.addEventListener("click", () => {
      vibrate([40]);
      alert(
        "NORMKI Tekton\n\n" +
          "Dieses Tool erstellt ein Foto mit Zeitstempel, optionalen GPS-Daten und SHA-256 Hash direkt im Bild. " +
          "Das Original ohne Overlay bleibt f√ºr Analyse & Normpr√ºfung erhalten. " +
          "Die Linien unter dem Header enthalten einen maschinenlesbaren Code (Zeit, Location, Hash-Short), " +
          "der aus dem Bild ausgelesen werden kann."
      );
    });

    console.log("NORMKI NTVS System geladen und bereit.");
  </script>
</body>
</html>


